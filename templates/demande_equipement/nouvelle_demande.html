{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Nouvelle demande d'équipement - ADD</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-bg {
            background: linear-gradient(120deg, #f0f4ff 0%, #e0e7ff 100%);
            min-height: 100vh;
        }
        .form-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .conditional-field {
            transition: all 0.3s ease;
        }
        .field-hidden {
            opacity: 0;
            height: 0;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body class="form-bg">
    <div class="min-h-screen py-8 px-4">
        <div class="max-w-4xl mx-auto">
            <!-- En-tête -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold bg-gradient-to-r from-indigo-600 to-cyan-500 bg-clip-text text-transparent mb-2">
                    Nouvelle demande d'équipement
                </h1>
                <p class="text-gray-600">Remplissez le formulaire ci-dessous pour soumettre votre demande</p>
            </div>

            <!-- Formulaire -->
            <div class="form-card rounded-2xl shadow-xl p-8" x-data="demandeForm()">
                <!-- Affichage des erreurs générales -->
                {% if form.non_field_errors %}
                    <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">Erreurs de validation</h3>
                                <div class="mt-2 text-sm text-red-700">
                                    <ul class="list-disc pl-5 space-y-1">
                                        {% for error in form.non_field_errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
                
                <form method="post">
                    {% csrf_token %}
                    
                    <!-- Section Catégorie et Type -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <!-- Catégorie -->
                        <div>
                            <label for="{{ form.categorie.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Catégorie *
                            </label>
                            {{ form.categorie }}
                            {% if form.categorie.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ form.categorie.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Type d'article -->
                        <div>
                            <label for="{{ form.type_article.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Type d'article *
                            </label>
                            {{ form.type_article }}
                            {% if form.type_article.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ form.type_article.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Type de demande -->
                        <div>
                            <label for="{{ form.type_demande.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Type de demande *
                            </label>
                            {{ form.type_demande }}
                            <!-- Champ caché pour forcer la valeur "nouveau" pour les fournitures -->
                            <input type="hidden" name="type_demande" value="nouveau" x-show="typeArticle === 'fourniture'">
                            {% if form.type_demande.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ form.type_demande.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Section Désignation et Description (conditionnelle) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8" 
                         x-show="showDesignationFields" 
                         x-transition:enter="transition ease-out duration-300"
                         x-transition:enter-start="opacity-0 transform -translate-y-4"
                         x-transition:enter-end="opacity-100 transform translate-y-0">
                        
                        <!-- Désignation Informatique -->
                        <div x-show="categorie === 'informatique'" x-transition>
                            <label for="{{ form.designation_info.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Désignation *
                            </label>
                            {{ form.designation_info }}
                            {% if form.designation_info.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ form.designation_info.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Désignation Bureau -->
                        <div x-show="categorie === 'bureau'" x-transition>
                            <label for="{{ form.designation_bureau.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Désignation *
                            </label>
                            {{ form.designation_bureau }}
                            {% if form.designation_bureau.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ form.designation_bureau.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Description Informatique -->
                        <div x-show="categorie === 'informatique'" x-transition>
                            <label for="{{ form.description_info.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Description *
                            </label>
                            {{ form.description_info }}
                            {% if form.description_info.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ form.description_info.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Description Bureau -->
                        <div x-show="categorie === 'bureau'" x-transition>
                            <label for="{{ form.description_bureau.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Description *
                            </label>
                            {{ form.description_bureau }}
                            {% if form.description_bureau.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ form.description_bureau.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>



                    <!-- Boutons -->
                    <div class="flex justify-end space-x-4">
                        <a href="{% url 'demande_equipement:liste_demandes' %}" 
                           class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                            Annuler
                        </a>
                        <button type="submit" 
                                class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-cyan-500 text-white rounded-lg hover:from-indigo-700 hover:to-cyan-600 transition-all transform hover:scale-105">
                            Soumettre la demande
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function demandeForm() {
            return {
                categorie: '',
                typeArticle: '',
                typeDemande: '',
                showDesignationFields: false,
                
                init() {
                    // Initialiser les valeurs depuis les champs
                    const categorieSelect = document.getElementById('id_categorie');
                    const typeArticleSelect = document.getElementById('id_type_article');
                    const typeDemandeSelect = document.getElementById('id_type_demande');
                    
                    if (categorieSelect) this.categorie = categorieSelect.value;
                    if (typeArticleSelect) this.typeArticle = typeArticleSelect.value;
                    if (typeDemandeSelect) this.typeDemande = typeDemandeSelect.value;
                    
                    this.updateForm();
                    
                    // Écouter les changements
                    if (categorieSelect) {
                        categorieSelect.addEventListener('change', (e) => {
                            this.categorie = e.target.value;
                            this.updateForm();
                        });
                    }
                    
                    if (typeArticleSelect) {
                        typeArticleSelect.addEventListener('change', (e) => {
                            this.typeArticle = e.target.value;
                            this.updateForm();
                        });
                    }
                    
                    if (typeDemandeSelect) {
                        typeDemandeSelect.addEventListener('change', (e) => {
                            this.typeDemande = e.target.value;
                            this.updateForm();
                        });
                    }
                    
                    // Écouter les changements de désignation
                    this.setupDesignationListeners();
                    
                    // Charger les désignations au démarrage si nécessaire
                    setTimeout(() => {
                        if (this.categorie && this.typeArticle === 'materiel') {
                            this.loadDesignations();
                        }
                    }, 100);
                },
                
                setupDesignationListeners() {
                    const designationInfo = document.getElementById('id_designation_info');
                    const designationBureau = document.getElementById('id_designation_bureau');
                    
                    if (designationInfo) {
                        designationInfo.addEventListener('change', (e) => {
                            if (e.target.value) {
                                this.loadDescriptions(e.target.value);
                            } else {
                                this.populateSelect('id_description_info', []);
                            }
                        });
                    }
                    
                    if (designationBureau) {
                        designationBureau.addEventListener('change', (e) => {
                            if (e.target.value) {
                                this.loadDescriptions(e.target.value);
                            } else {
                                this.populateSelect('id_description_bureau', []);
                            }
                        });
                    }
                },
                
                updateForm() {
                    // Filtrer les types d'article selon la catégorie
                    this.filterTypeArticleOptions();
                    
                    // Afficher/masquer les champs de désignation
                    this.showDesignationFields = this.typeArticle === 'materiel';
                    
                    // Vider les champs de désignation et description quand la catégorie change
                    if (this.showDesignationFields) {
                        this.clearDesignationFields();
                    }
                    
                    // Charger les désignations selon la catégorie
                    if (this.categorie && this.showDesignationFields) {
                        this.loadDesignations();
                    }
                    
                    // Mettre à jour les types de demande pour les fournitures
                    if (this.typeArticle === 'fourniture') {
                        const typeDemandeSelect = document.getElementById('id_type_demande');
                        if (typeDemandeSelect) {
                            typeDemandeSelect.value = 'nouveau';
                            typeDemandeSelect.disabled = true;
                            // Forcer la soumission de la valeur
                            const hiddenInput = document.querySelector('input[name="type_demande"][type="hidden"]');
                            if (hiddenInput) {
                                hiddenInput.value = 'nouveau';
                            }
                        }
                    } else {
                        const typeDemandeSelect = document.getElementById('id_type_demande');
                        if (typeDemandeSelect) {
                            typeDemandeSelect.disabled = false;
                        }
                    }
                    
                    // Debug: afficher l'état
                    console.log('updateForm:', {
                        categorie: this.categorie,
                        typeArticle: this.typeArticle,
                        showDesignationFields: this.showDesignationFields
                    });
                },
                
                filterTypeArticleOptions() {
                    const typeArticleSelect = document.getElementById('id_type_article');
                    if (!typeArticleSelect) return;
                    
                    // Sauvegarder la valeur actuelle
                    const currentValue = typeArticleSelect.value;
                    
                    // Vider les options existantes
                    typeArticleSelect.innerHTML = '';
                    
                    if (this.categorie === 'informatique') {
                        // Pour informatique : seulement Matériel
                        const option = document.createElement('option');
                        option.value = 'materiel';
                        option.textContent = 'Matériel';
                        typeArticleSelect.appendChild(option);
                        
                        // Forcer la sélection sur "materiel"
                        typeArticleSelect.value = 'materiel';
                        this.typeArticle = 'materiel';
                    } else if (this.categorie === 'bureau') {
                        // Pour bureau : Matériel et Fourniture
                        const optionMateriel = document.createElement('option');
                        optionMateriel.value = 'materiel';
                        optionMateriel.textContent = 'Matériel';
                        typeArticleSelect.appendChild(optionMateriel);
                        
                        const optionFourniture = document.createElement('option');
                        optionFourniture.value = 'fourniture';
                        optionFourniture.textContent = 'Fourniture';
                        typeArticleSelect.appendChild(optionFourniture);
                        
                        // Restaurer la valeur précédente si elle était valide
                        if (currentValue === 'fourniture' || currentValue === 'materiel') {
                            typeArticleSelect.value = currentValue;
                            this.typeArticle = currentValue;
                        } else {
                            // Par défaut, sélectionner "materiel"
                            typeArticleSelect.value = 'materiel';
                            this.typeArticle = 'materiel';
                        }
                    }
                },
                
                clearDesignationFields() {
                    // Vider les champs de désignation et description
                    const designationInfo = document.getElementById('id_designation_info');
                    const designationBureau = document.getElementById('id_designation_bureau');
                    const descriptionInfo = document.getElementById('id_description_info');
                    const descriptionBureau = document.getElementById('id_description_bureau');
                    
                    if (designationInfo) designationInfo.innerHTML = '<option value="">---------</option>';
                    if (designationBureau) designationBureau.innerHTML = '<option value="">---------</option>';
                    if (descriptionInfo) descriptionInfo.innerHTML = '<option value="">---------</option>';
                    if (descriptionBureau) descriptionBureau.innerHTML = '<option value="">---------</option>';
                },
                
                async loadDesignations() {
                    try {
                        console.log('Chargement des désignations pour:', this.categorie);
                        const response = await fetch(`{% url 'demande_equipement:get_designations' %}?categorie=${this.categorie}`);
                        const data = await response.json();
                        console.log('Désignations reçues:', data);
                        
                        if (this.categorie === 'informatique') {
                            this.populateSelect('id_designation_info', data.designations);
                        } else if (this.categorie === 'bureau') {
                            this.populateSelect('id_designation_bureau', data.designations);
                        }
                    } catch (error) {
                        console.error('Erreur lors du chargement des désignations:', error);
                    }
                },
                
                async loadDescriptions(designationId) {
                    try {
                        const response = await fetch(`{% url 'demande_equipement:get_descriptions' %}?categorie=${this.categorie}&designation_id=${designationId}`);
                        const data = await response.json();
                        
                        if (this.categorie === 'informatique') {
                            this.populateSelect('id_description_info', data.descriptions);
                        } else if (this.categorie === 'bureau') {
                            this.populateSelect('id_description_bureau', data.descriptions);
                        }
                    } catch (error) {
                        console.error('Erreur lors du chargement des descriptions:', error);
                    }
                },
                
                populateSelect(selectId, options) {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">---------</option>';
                    
                    options.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.id;
                        optionElement.textContent = option.nom;
                        select.appendChild(optionElement);
                    });
                },
                
                validateForm(event) {
                    // Validation côté client - temporairement désactivée pour debug
                    console.log('validateForm called');
                    console.log('Form data:', {
                        categorie: this.categorie,
                        typeArticle: this.typeArticle,
                        typeDemande: this.typeDemande
                    });
                    
                    // Validation côté client
                    if (this.typeArticle === 'materiel' && !this.categorie) {
                        alert('Veuillez sélectionner une catégorie pour les matériels');
                        event.preventDefault();
                        return false;
                    }
                    
                    if (this.typeArticle === 'fourniture' && this.typeDemande !== 'nouveau') {
                        alert('Pour les fournitures, le type de demande doit être "Nouveau"');
                        event.preventDefault();
                        return false;
                    }
                    
                    console.log('Form validation passed, submitting...');
                    return true;
                }
            }
        }
        

    </script>
</body>
</html> 